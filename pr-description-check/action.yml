# Copyright (c) 2025, NVIDIA CORPORATION.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

name: 'PR Description Check'
description: 'check if comment exists in PR description'

runs:
  using: "composite"
  steps:
    - name: Get PR description
      id: pr_description
      uses: actions/github-script@v7
      with:
        script: |
          const owner = context.repo.owner;
          const repo = context.repo.repo;
          const sha = context.payload.pull_request?.head?.sha;
          const targetUrl = context.payload.pull_request?.html_url;

          const prBody = context.payload.pull_request?.body || '';
          const checkError = prBody.includes('<!--');

          const octokit = new Octokit({
              auth: ${{ secrets.GIT_TOKEN }}
            });

          if (checkError) {
            core.setFailed('PR description contains comment in "<!--". Please remove the comment manually.');
            const state = 'failure';
            const description = 'PR description contains comment in "<!--". Please remove the comment manually.';
          } else {
            const state = 'success';
            const description = 'PR description is valid.';
          }

          await octokit.request('POST /repos/{owner}/{repo}/statuses/{sha}', {
            owner: owner,
            repo: repo,
            sha: sha,
            state: state,
            target_url: targetUrl,
            description: description,
            context: 'pr-description-check',
            headers: {
              'X-GitHub-Api-Version': '2022-11-28'
            }
          });